<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Club Payments System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #000000, #1a0033, #33004d);
      color: white;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #ffd700;
    }
    .payment-section, .product-selection-section {
      margin: 20px auto;
      padding: 20px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
      border: 2px solid #ffd700;
      width: 90%;
      max-width: 600px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    select, input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: none;
    }
    button {
      background-color: #ffd700;
      color: black;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
    }
    button:hover {
      background-color: #ffa500;
    }
    #productList {
      margin-top: 20px;
    }
    .product-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #444;
      background: rgba(255, 215, 0, 0.1);
      margin-bottom: 5px;
      border-radius: 5px;
    }
    #totalAmountDisplay {
      font-size: 1.4em;
      margin: 15px 0;
      padding: 15px;
      background: rgba(255, 215, 0, 0.2);
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    .payment-method {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    .payment-method input {
      flex: 1;
    }
    .delete-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Receipt Modal Styles */
    .receipt-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .receipt-content {
      background: white;
      color: black;
      padding: 20px;
      border-radius: 5px;
      width: 280px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .receipt-header {
      text-align: center;
      margin-bottom: 10px;
      border-bottom: 1px dashed #000;
      padding-bottom: 10px;
    }
    .receipt-header h2 {
      font-size: 18px;
      margin: 0;
    }
    .receipt-items {
      margin: 10px 0;
    }
    .receipt-item {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }
    .receipt-totals {
      margin-top: 10px;
      border-top: 1px dashed #000;
      padding-top: 10px;
    }
    .receipt-total-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }
    .receipt-footer {
      text-align: center;
      margin-top: 10px;
      font-size: 12px;
      border-top: 1px dashed #000;
      padding-top: 10px;
    }
    .print-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .btn-print {
      background-color: #4CAF50;
      color: white;
    }
    .btn-close {
      background-color: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Club Payments System</h1>

  <div class="product-selection-section">
    <h2>Record Sale</h2>
    <label for="productSelect">Select Product:</label>
    <select id="productSelect">
      <option value="">-- Loading Products... --</option>
    </select>
    
    <label for="quantity">Quantity:</label>
    <input type="number" id="quantity" min="1" value="1">
    
    <button onclick="addToSale()">Add to Sale</button>
    
    <div id="productList">
      <h3>Items to Sell:</h3>
      <div id="soldProductsList"></div>
      <div id="totalAmountDisplay"></div>
    </div>
  </div>

  <div class="payment-section">
    <h2>Record Payment</h2>
    <div class="payment-method">
      <div>
        <label for="mpesaAmount">Mpesa Amount:</label>
        <input type="number" id="mpesaAmount" placeholder="0">
      </div>
      <div>
        <label for="cashAmount">Cash Amount:</label>
        <input type="number" id="cashAmount" placeholder="0">
      </div>
    </div>
    <button onclick="completeSale()">Complete Sale</button>
  </div>

  <!-- Receipt Modal -->
  <div id="receiptModal" class="receipt-modal">
    <div class="receipt-content">
      <div class="receipt-header">
        <h2>MALIISA CLUB</h2>
        <p>Official Receipt</p>
        <p id="receiptDateTime"></p>
        <p>-----------------------------</p>
      </div>
      
      <div class="receipt-items" id="receiptItems">
        <!-- Items will be inserted here -->
      </div>
      
      <div class="receipt-totals">
        <div class="receipt-total-row">
          <span>Subtotal:</span>
          <span id="receiptSubtotal">0.00</span>
        </div>
        <div class="receipt-total-row">
          <span>MPESA:</span>
          <span id="receiptMpesa">0.00</span>
        </div>
        <div class="receipt-total-row">
          <span>CASH:</span>
          <span id="receiptCash">0.00</span>
        </div>
        <div class="receipt-total-row" style="font-weight: bold;">
          <span>TOTAL:</span>
          <span id="receiptTotal">0.00</span>
        </div>
      </div>
      
      <div class="receipt-footer">
        <p>Thank you for your business!</p>
        <p>www.maliisaclub.com</p>
        <p>-----------------------------</p>
        <p>*** Computer Generated ***</p>
      </div>
      
      <div class="print-actions">
        <button onclick="printReceipt()" class="btn-print">Print Receipt</button>
        <button onclick="closeReceipt()" class="btn-close">Close</button>
      </div>
    </div>
  </div>

  <script>
    let saleItems = [];
    let totalAmount = 0;

    // Load products from main system
    function loadProducts() {
      const products = JSON.parse(localStorage.getItem("products")) || [];
      const select = document.getElementById("productSelect");
      
      select.innerHTML = '<option value="">-- Select Product --</option>';
      
      products.forEach(product => {
        const option = document.createElement("option");
        option.value = product.id;
        option.textContent = `${product.name}${product.size ? ` (${product.size})` : ''} - ${product.price} Ksh`;
        option.dataset.name = product.name;
        option.dataset.size = product.size || '';
        option.dataset.price = product.price;
        select.appendChild(option);
      });
    }

    function addToSale() {
      const select = document.getElementById("productSelect");
      const option = select.options[select.selectedIndex];
      const quantity = parseInt(document.getElementById("quantity").value);
      
      if (!option.value) {
        alert("Please select a product");
        return;
      }
      
      if (isNaN(quantity) || quantity <= 0) {
        alert("Please enter valid quantity");
        return;
      }
      
      // Check if product already in sale
      const existingIndex = saleItems.findIndex(item => 
        item.id === option.value
      );
      
      if (existingIndex >= 0) {
        saleItems[existingIndex].quantity += quantity;
      } else {
        saleItems.push({
          id: option.value,
          name: option.dataset.name,
          size: option.dataset.size,
          price: parseFloat(option.dataset.price),
          quantity: quantity
        });
      }
      
      updateSaleDisplay();
    }

    function updateSaleDisplay() {
      const list = document.getElementById("soldProductsList");
      list.innerHTML = '';
      
      totalAmount = saleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      saleItems.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "product-item";
        div.innerHTML = `
          <span>${item.name}${item.size ? ` (${item.size})` : ''} x ${item.quantity} @ ${item.price} Ksh</span>
          <span>${(item.price * item.quantity).toFixed(2)} Ksh</span>
          <button class="delete-btn" onclick="removeItem(${index})">Ã—</button>
        `;
        list.appendChild(div);
      });
      
      document.getElementById("totalAmountDisplay").innerHTML = `
        <div>Total: ${totalAmount.toFixed(2)} Ksh</div>
      `;
    }

    function removeItem(index) {
      saleItems.splice(index, 1);
      updateSaleDisplay();
    }

    function generateReceipt(mpesa, cash) {
      const now = new Date();
      document.getElementById("receiptDateTime").textContent = now.toLocaleString();
      
      const itemsContainer = document.getElementById("receiptItems");
      itemsContainer.innerHTML = '';
      
      // Add items to receipt
      saleItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'receipt-item';
        itemDiv.innerHTML = `
          <span>${item.name}${item.size ? `(${item.size})` : ''}</span>
          <span>${item.quantity} x ${item.price.toFixed(2)}</span>
          <span>${(item.price * item.quantity).toFixed(2)}</span>
        `;
        itemsContainer.appendChild(itemDiv);
      });
      
      // Update totals
      document.getElementById("receiptSubtotal").textContent = `${totalAmount.toFixed(2)}`;
      document.getElementById("receiptMpesa").textContent = `${mpesa.toFixed(2)}`;
      document.getElementById("receiptCash").textContent = `${cash.toFixed(2)}`;
      document.getElementById("receiptTotal").textContent = `${totalAmount.toFixed(2)}`;
      
      // Show receipt modal
      document.getElementById("receiptModal").style.display = 'flex';
    }

    function printReceipt() {
      window.print();
    }

    function closeReceipt() {
      document.getElementById("receiptModal").style.display = 'none';
    }

    function completeSale() {
      const mpesa = parseFloat(document.getElementById("mpesaAmount").value) || 0;
      const cash = parseFloat(document.getElementById("cashAmount").value) || 0;
      
      if (saleItems.length === 0) {
        alert("No items in sale");
        return;
      }
      
      if (Math.abs((mpesa + cash) - totalAmount) > 0.01) {
        alert(`Payment amounts (${(mpesa + cash).toFixed(2)}) must equal sale total (${totalAmount.toFixed(2)})`);
        return;
      }
      
      // Update stock in main window
      try {
        if (window.opener && window.opener.updateStockQuantities) {
          const success = window.opener.updateStockQuantities(saleItems.map(item => ({
            name: item.name,
            size: item.size,
            quantity: item.quantity
          })));
          
          if (success) {
            // Generate and show receipt
            generateReceipt(mpesa, cash);
            
            // Reset form
            saleItems = [];
            updateSaleDisplay();
            document.getElementById("mpesaAmount").value = "";
            document.getElementById("cashAmount").value = "";
          } else {
            alert("Failed to update stock");
          }
        } else {
          alert("Main system not available - stock not updated");
        }
      } catch (e) {
        console.error("Error updating stock:", e);
        alert("Error updating stock - see console for details");
      }
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", function() {
      loadProducts();
      
      // Refresh products every 2 seconds
      setInterval(loadProducts, 2000);
      
      // Set up print styles
      const style = document.createElement('style');
      style.textContent = `
        @media print {
          body * {
            visibility: hidden;
          }
          .receipt-content, .receipt-content * {
            visibility: visible;
          }
          .receipt-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            max-width: 100%;
            box-shadow: none;
            border: none;
          }
          .print-actions {
            display: none !important;
          }
        }
      `;
      document.head.appendChild(style);
    });
  </script>
</body>
</html>